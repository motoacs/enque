# Enque プロジェクト計画書 v4

## 1. プロジェクト概要

Enqueは、rigaya氏のNVEncC（NVEncC64.exe）のWindows用GUIラッパーアプリケーションである。カメラで撮影した動画や各種映像ファイルを、ドラッグ＆ドロップで追加し、NVIDIAのハードウェアエンコーダ（NVENC）を用いて一括エンコードする。RTX 5090の3基NVENCエンジンを活用した高速エンコードに対応する。

対象ユーザーはNVEncCのコマンドラインオプションを理解している上級者であり、GUIは日常のバッチエンコード作業を効率化するためのプロの道具として設計する。主要なオプションをGUIウィジェットで提供しつつ、任意のコマンドラインオプションをテキスト入力で追加できる柔軟性を持つ。

### 技術スタック

| 領域 | 技術 |
|---|---|
| バックエンド | Go |
| デスクトップフレームワーク | Wails v2 |
| フロントエンド | React + TypeScript + Vite |
| 状態管理 | Zustand |
| UIスタイリング | Tailwind CSS + shadcn/ui |
| データ永続化 | JSONファイル |
| 外部依存 | NVEncC64.exe 8.x以降（必須）、ffmpeg.exe / ffprobe.exe（任意） |

### 対象NVEncCバージョン

NVEncC 8.x系（NVENC API 13.0）以降を対象とする。7.x以前はサポート外とし、起動時にバージョンを検出して警告を表示する。

---

## 2. ユーザーストーリー

### 基本ワークフロー

**US-01**: ユーザーとして、アプリを起動し、エンコードしたい動画ファイルをウィンドウにドラッグ＆ドロップしてジョブキューに追加したい。

**US-02**: ユーザーとして、プロファイル（エンコード設定のまとまり）を選択し、キュー内の全ファイルに適用したい。

**US-03**: ユーザーとして、「エンコード開始」ボタンを押して、キュー内のファイルをエンコードし、各ファイルの進捗をリアルタイムで確認したい。

**US-04**: ユーザーとして、エンコード完了後に出力ファイルの作成日時が元ファイルの撮影日時を保持しており、タイムライン表示で正しく並ぶことを期待する。

### プロファイル管理

**US-05**: ユーザーとして、よく使うエンコード設定をプロファイルとして保存し、名前を付けて管理したい。

**US-06**: ユーザーとして、プロファイルの主要な設定（コーデック、品質、音声等）をGUIウィジェットで変更したい。

**US-07**: ユーザーとして、GUIに用意されていないNVEncCオプションを、テキスト入力欄にコマンドラインオプションとして自由に追加したい。

**US-08**: ユーザーとして、最終的に実行されるNVEncCコマンドラインを常に確認でき、クリップボードにコピーしたい。

### キュー操作

**US-09**: ユーザーとして、ジョブキューのファイルをドラッグで並べ替えたり、不要なファイルを削除したい。

**US-10**: ユーザーとして、ファイルダイアログからファイルまたはフォルダを指定してキューに追加したい。フォルダ指定時はサブフォルダの再帰探索を選択できる。

### エンコード実行制御

**US-11**: ユーザーとして、エンコード中にキューの停止（次のジョブを開始しない）や、実行中ジョブのキャンセルを行いたい。

**US-12**: ユーザーとして、あるファイルのエンコードが失敗した場合、そのファイルをスキップして次のファイルに進むか、全体を停止するかを選択したい。

**US-13**: ユーザーとして、全ファイルのエンコード完了後に、シャットダウン・スリープ等の自動アクションを設定したい。

### 高速エンコード

**US-14**: ユーザーとして、RTX 5090の3基NVENCエンジンを活用するため、ジョブ内並列化（split-enc / parallel）やプロセス並列（同時実行数）をプロファイルまたはアプリ設定から制御したい。

### 環境確認

**US-15**: ユーザーとして、アプリからGPU情報（搭載NVENCエンジン数、対応コーデック等）を確認したい。

**US-16**: ユーザーとして、NVEncC64.exeのパスが見つからない場合に設定画面から指定したい。

---

## 3. 機能要件

### F-01: ジョブキュー管理

- ドラッグ＆ドロップによるファイル追加（複数ファイル、フォルダ対応）
- ファイルダイアログによるファイル・フォルダ追加（フォルダ時はサブフォルダ再帰探索オプション）
- キュー内のジョブの並べ替え（ドラッグ）、削除、全クリア
- ジョブごとにファイル名、ファイルサイズ、ステータス（待機 / 実行中 / 完了 / エラー / スキップ）を表示
- 入力ファイルの解像度・コーデック等の情報取得はスコープ外。ファイル名とサイズのみ表示する
- エンコード実行中はキュー編集をロックする

### F-02: プロファイル管理

- プロファイルの作成・保存・複製・削除・リネーム
- デフォルトプロファイルの設定
- プリセットプロファイルをアプリに同梱（後述）
- プロファイルJSONに `version` フィールドを持ち、アプリ更新時にマイグレーション可能な構造とする
- 現状はキュー全体に1つのプロファイルを適用する。将来のジョブ個別プロファイル割り当てに拡張可能なデータ構造とする

### F-03: エンコード設定 — GUIウィジェット（第1層）

日常的に使う主要オプションをGUIウィジェットで提供する。

**映像基本**

| 設定項目 | NVEncCオプション | UIコントロール |
|---|---|---|
| コーデック | `-c` | セグメントボタン (H.264 / HEVC / AV1) |
| レート制御モード | `--qvbr` / `--cqp` / `--cbr` / `--vbr` | ドロップダウン |
| 品質値 / ビットレート | (上記の引数) | 数値入力 |
| プリセット | `-u` / `--preset` | ドロップダウン (P1〜P7) |
| 出力ビット深度 | `--output-depth` | ドロップダウン (8 / 10) |
| マルチパス | `--multipass` | ドロップダウン (none / quarter / full) |
| 出力解像度 | `--output-res` | テキスト入力 (例: 1920x1080, 空=変更なし) |

**映像詳細**

| 設定項目 | NVEncCオプション | UIコントロール |
|---|---|---|
| Bフレーム数 | `--bframes` | 数値入力 (0〜7) |
| 参照フレーム数 | `--ref` | 数値入力 |
| ルックアヘッド | `--lookahead` | 数値入力 (0〜32) |
| GOP長 | `--gop-len` | 数値入力 |
| AQ (空間) | `--aq` | トグル |
| AQ (時間) | `--aq-temporal` | トグル |

**高速化（ジョブ内並列）**

| 設定項目 | NVEncCオプション | UIコントロール |
|---|---|---|
| Split Encoding | `--split-enc` | ドロップダウン (off / auto / auto_forced / forced_2 / forced_3 / forced_4) |
| Parallel Encoding | `--parallel` | ドロップダウン (off / auto / 2 / 3) |
| デコーダ | `--avhw` / `--avsw` | ドロップダウン |
| デバイス指定 | `--device` | ドロップダウン (auto / GPU ID) |

`--split-enc` / `--parallel` はNVEncCのバージョンやGPU世代によって対応コーデックが異なる。UI上はコーデックに関わらず常に選択可能とするが、H.264選択時には「NVEncCの制約により、HEVC/AV1以外では失敗する場合があります」の注釈を表示する。NVEncCがエラーを返した場合はそのエラーメッセージをログに表示し、ジョブをエラーとして処理する。

**音声**

| 設定項目 | NVEncCオプション | UIコントロール |
|---|---|---|
| 音声処理 | `--audio-copy` / `--audio-codec` | ドロップダウン (Copy / AAC / Opus) |
| 音声ビットレート | `--audio-bitrate` | 数値入力 (128, 192, 256, 320 等) |

**色空間・HDR**

| 設定項目 | NVEncCオプション | UIコントロール |
|---|---|---|
| Color Matrix | `--colormatrix` | ドロップダウン (auto / bt709 / bt2020nc 等) |
| Transfer | `--transfer` | ドロップダウン (auto / bt709 / smpte2084 / arib-std-b67 等) |
| Color Primaries | `--colorprim` | ドロップダウン (auto / bt709 / bt2020 等) |
| Color Range | `--colorrange` | ドロップダウン (auto / limited / full) |
| MaxCLL | `--max-cll` | テキスト入力 (copy / 手動値) |
| Master Display | `--master-display` | テキスト入力 (copy / 手動値) |
| HDR10+ | `--dhdr10-info` | ドロップダウン (off / copy) |
| Dolby Vision RPU | `--dolby-vision-rpu` | ドロップダウン (off / copy) |

**メタデータ**

| 設定項目 | NVEncCオプション | UIコントロール |
|---|---|---|
| 一括コピー | (下記を一括ON/OFF) | トグル |
| コンテナメタデータ | `--metadata copy` | トグル |
| 映像メタデータ | `--video-metadata copy` | トグル |
| 音声メタデータ | `--audio-metadata copy` | トグル |
| チャプター | `--chapter-copy` | トグル |
| 字幕 | `--sub-copy` | トグル |
| データトラック | `--data-copy` | トグル |
| 添付ファイル | `--attachment-copy` | トグル |
| ファイル日時復元 | (アプリ独自機能) | トグル |

### F-04: カスタムオプション（第2層）

GUIに載せていないNVEncCオプションを、テキスト入力欄にそのまま記述できる。例:

```
--gop-len 300 --lookahead-level 3 --vpp-nlmeans sigma=0.005
```

入力内容は第1層のGUI設定で生成されたオプション列の末尾に追加される。NVEncCの後方優先（later wins）の挙動により、同一オプションがGUI側とテキスト側の両方にある場合、テキスト側が上書きする。

### F-05: コマンドラインプレビュー

第1層と第2層を合成した最終的なNVEncCコマンドラインを常時表示する。プロファイルや設定の変更に連動してリアルタイム更新される。クリップボードへのコピーボタンを備える。表示は参考用であり、コピペ実行を完全に保証するものではない。

### F-06: 出力設定

- 出力先フォルダ: 入力と同じフォルダ / 指定フォルダ
- 出力ファイル名テンプレート: 変数 `{name}`（拡張子なし元ファイル名）, `{ext}`（出力コンテナ拡張子）等を使用可能。デフォルト: `{name}_encoded.{ext}`
- 出力コンテナ: mp4 / mkv / mov / webm 等を自由に選択。コーデックとの互換性チェックはアプリ側では行わない（ユーザー責任）
- 既存ファイルとの衝突時: 上書き確認 / 自動リネーム（末尾に連番付与）

### F-07: エンコード実行

- 「エンコード開始」でフロントエンドのジョブキュー・プロファイル・出力設定をまとめてGoバックエンドに送信
- Goはジョブを実行する。同時実行数の設定に従い、1〜N個のNVEncCプロセスを並列に起動する（詳細は6.3節）
- 各ジョブの出力パス確定はジョブ開始直前にmutex下で行い、並列時の名前衝突を防止する。エンコードは一時ファイル `{dir}/{name}.{job_id}.tmp.{ext}` に出力し（最終拡張子を維持することでNVEncCのコンテナ判定を正常に動作させる）、成功後に最終ファイル名 `{dir}/{name}.{ext}` にリネーム（原子的）した上でファイル日時を復元する。エンコード失敗時の一時ファイルはデフォルトで削除する。アプリ設定 `keep_failed_temp`（デフォルトfalse）がtrueの場合は削除せず残す（問題調査用）
- NVEncCのstderr出力をリアルタイムに解析し、進捗（パーセント、fps、ビットレート、残り時間）をWailsイベントでフロントに通知する。パースが失敗した場合は進捗を「不明」として扱い、エンコード自体は続行する。ログウィンドウには常に生の出力を表示する
- ジョブごとの進捗バーおよび全体の進捗（完了数/全数）を表示
- UI上に以下の実行状態を表示する: 同時実行数（現在稼働中/最大）、各ジョブの開始時刻・経過時間、終了コード
- ログウィンドウにNVEncCの出力をリアルタイム表示（フロント側はリングバッファで最新N行を保持）
- ジョブごとに以下をファイルに保存する:
  - `{job_id}.json`: 下記6.11節のスキーマに従うジョブ実行記録
  - `{job_id}.stderr.log`: NVEncCのstderr出力全文
- アプリ起動時に、前回のクラッシュ等で残存した一時ファイル（`*.tmp.{ext}` パターン）をスキャンし、検出された場合はユーザーに削除を提示する

### F-08: エンコード実行制御

- **停止（Graceful Stop）**: 「停止」ボタンで次のジョブの開始を抑止する。実行中のジョブは完了まで走る
- **中止（Abort）**: 「中止」ボタンで実行中の全ジョブを強制終了し、キュー処理を即座に終了する
- **ジョブのキャンセル**: 実行中の個別ジョブを強制終了する
- プロセスの強制終了にはJob Object（`TerminateJobObject`）を使用する。Job Objectの使用に失敗した場合は `taskkill /F /T /PID` にフォールバックする（詳細は6.6節）
- 一時停止（プロセスサスペンド）機能は提供しない
- エラー時動作: スキップして次のジョブへ（`on_error: "skip"`）/ 停止（`on_error: "stop"`、graceful stop と同じ動作 — 実行中ジョブは完了まで走り、次のジョブを開始しない）。アプリ設定で選択
- ハング検出: 以下の2段階で判定する
  - **出力タイムアウト** (`no_output_timeout_sec`, デフォルト600秒): stderrから何らかの行を最後に受信してからの経過時間。NVEncCプロセスが完全に無応答になった場合を検出する
  - **進捗タイムアウト** (`no_progress_timeout_sec`, デフォルト300秒): 進捗パースに成功して進捗値が最後に更新されてからの経過時間。プロセスは動いているがエンコードが停滞している場合を検出する。ただし進捗パースが不能な状態（出力形式不明等）の場合はこのタイムアウトを適用しない（出力タイムアウトのみで判定）
  - いずれかのタイムアウトに達した場合、プロセスを強制終了し、アプリ設定に従いスキップまたは全体停止する
- デコーダフォールバック: `--avhw` でエンコードが失敗した場合（終了コード非0）に `--avsw` に切り替えて1回だけ自動再試行するオプション。アプリ設定でON/OFF可能、デフォルトOFF

### F-09: ファイル日時復元

エンコード完了後（一時ファイルから最終ファイルへのリネーム後）、元ファイルのファイルシステムタイムスタンプを出力ファイルにコピーする。復元対象は作成日時（CreationTime）と更新日時（LastWriteTime）の2つとする。アクセス日時（LastAccessTime）は復元対象外とする。Win32 API（`CreateFile` + `GetFileTime` + `SetFileTime`）を使用する。プロファイルのメタデータ設定で個別にON/OFF可能。

コンテナ内部のメタデータ（creation_time等）の保持はNVEncCの `--metadata copy` 等に委ねる。ファイルシステム日時復元とコンテナメタデータコピーの両方をデフォルトONにしたプリセット（Camera Archive）を提供することで、カメラ動画のタイムライン並び順の保持を実現する。

### F-10: 完了後アクション

全ジョブのエンコード完了後に実行するアクション。何もしない（デフォルト）/ シャットダウン / スリープ / カスタムコマンド実行。

### F-11: GPU情報表示

`NVEncC64.exe --check-device` および `--check-features` の実行結果を表示するダイアログ。搭載GPU名、NVENCエンジン数、対応コーデック・機能を確認できる。

### F-12: 外部ツールパス設定

起動時に同一フォルダ → PATH の順で NVEncC64.exe を検出する。検索候補は `NVEncC64.exe`, `NVEncC.exe` の複数名。見つからない場合はパス設定ダイアログを表示する。設定画面からいつでも変更可能。

ffmpeg.exe / ffprobe.exe のパス設定欄も設ける（任意）。検出された場合のみ、将来的な追加機能（メタデータ補完等）に利用可能とする。初期バージョンではffmpegが必須となる機能はない。

### F-13: 同梱プリセットプロファイル

以下のプリセットをアプリに同梱する。ユーザーは複製して編集可能。各プリセットの設計意図をREADMEに記載する。

- **HEVC Quality**: HEVC, QVBR 28, P4, 10bit, メタデータ全コピー, split-enc auto。汎用的な高画質設定。P4はエンコード速度と品質のバランスが良い中間プリセット
- **AV1 Fast**: AV1, QVBR 32, P1, 10bit, 音声コピー, split-enc auto。最速のAV1エンコード。画質よりスループット優先
- **Camera Archive**: HEVC, QVBR 24, P7, 10bit, メタデータ全コピー, ファイル日時復元ON, 音声コピー。カメラ撮影素材のアーカイブ用途。P7は最高品質だが低速。音声は再エンコードによる劣化を避けコピー。メタデータとファイル日時を全て保持し、タイムライン表示での並び順を維持する
- **H.264 Compatible**: H.264, QVBR 26, P4, 8bit, 音声AAC 256kbps。互換性最優先。古いデバイスやプレーヤーでの再生を想定

---

## 4. 非機能要件

| 項目 | 要件 |
|---|---|
| 対応OS | Windows 11 (x64)。WebView2はWindows 11に標準搭載 |
| 外部依存 | NVEncC64.exe 8.x以降（必須）。ffmpeg.exe / ffprobe.exe（任意）。いずれもアプリに内蔵せず、同一フォルダまたはPATHから検出。READMEに入手先を明記する |
| UI応答性 | エンコード中もGUI操作（ログ閲覧、進捗確認等）がフリーズしない |
| メモリ | GUI本体は200MB以下（エンコードプロセスは別プロセス） |
| 設定永続化 | プロファイル・アプリ設定はJSONで `%APPDATA%/Enque/` 以下に保存 |
| ログ永続化 | ジョブごとの実行コマンドライン（argv）と stderr ログを `%APPDATA%/Enque/logs/` 以下にファイル保存。成功・失敗の再現性を確保する |
| 多言語 | 日本語・英語の2言語対応。i18nの仕組みは初期段階で組み込む |
| 配布 | ZIP配布（exe + README）。インストーラー不要 |
| バイナリサイズ | 20MB以下（Wails v2の標準的な範囲） |

---

## 5. 制約

- 動画のプレビュー機能は実装しない
- カット・結合・分割等の編集機能は実装しない
- 入力ファイルの解像度・コーデック等の情報取得はスコープ外（将来的にffprobeベースで追加可能）
- コーデックと出力コンテナの互換性チェックはアプリ側では行わない（ユーザー責任）
- エンコード実行中のジョブキュー編集は不可（ロック）
- 一時停止（プロセスサスペンド）機能は提供しない
- ジョブ個別のプロファイル割り当ては初期バージョンでは実装しない（データ構造は拡張を想定）
- NVEncC 7.x以前はサポート外

---

## 6. 設計

### 6.1 アーキテクチャ

```
┌──────────────────────────────────────────────────────────┐
│ Wails v2 Application                                     │
│                                                          │
│  ┌─ Frontend (React + TS) ────────────────────────────┐  │
│  │                                                     │  │
│  │  editStore ──── ジョブリスト、プロファイル編集中状態  │  │
│  │  profileStore ─ プロファイル定義一覧                 │  │
│  │  encodeStore ── エンコード中の進捗・ステータス       │  │
│  │  appStore ───── GPU情報、外部ツールパス、アプリ設定   │  │
│  │                                                     │  │
│  └──────────┬──────────────────────┬───────────────────┘  │
│     Wails Binding (関数呼出)   Wails Events (Go→JS)      │
│  ┌──────────▼──────────────────────▼───────────────────┐  │
│  │                                                     │  │
│  │  app.go ── Wailsバインド対象のメソッド群             │  │
│  │     │                                               │  │
│  │  backend/                                           │  │
│  │  ├── encoder/                                       │  │
│  │  │   ├── command_builder.go  コマンドライン構築      │  │
│  │  │   ├── process.go          プロセス実行・監視      │  │
│  │  │   └── progress_parser.go  stderr解析             │  │
│  │  ├── queue/                                         │  │
│  │  │   └── manager.go          ジョブキュー + ワーカー │  │
│  │  ├── profile/                                       │  │
│  │  │   ├── model.go            構造体 + JSON          │  │
│  │  │   └── manager.go          CRUD + マイグレーション │  │
│  │  ├── detector/                                      │  │
│  │  │   └── nvencc.go           検出・バージョン・GPU   │  │
│  │  ├── metadata/                                      │  │
│  │  │   └── file_time_windows.go  Win32 SetFileTime    │  │
│  │  └── config/                                        │  │
│  │      └── app_config.go       アプリ設定の永続化      │  │
│  │                                                     │  │
│  └─────────────────────────────────────────────────────┘  │
└──────────────────────┬───────────────────────────────────┘
                       │ os/exec
                       ▼
              NVEncC64.exe ×N (外部バイナリ、最大同時実行数分)
```

### 6.2 状態管理とデータフロー

フェーズ（エンコード前 / エンコード中）によってsource of truthが異なる設計とする。

**エンコード開始前**: フロントエンドのZustand storeがsource of truth。ジョブの追加・削除・並べ替え、プロファイルの選択・編集はすべてフロント内で完結する。Go側にはプロファイルの永続化（保存ボタン押下時）とGPU情報取得（起動時）のみ問い合わせる。

**エンコード開始時**: フロントエンドは `editStore` の内容（ジョブリスト + プロファイル + 出力設定 + 同時実行数）をまとめてGoの `StartEncode()` に送信する。以降はGo側がsource of truth。

**エンコード中**: Go側がNVEncCプロセスを管理し、進捗をWailsイベントでフロントに通知する。フロントの `encodeStore` はイベントを受信して進捗UIを更新する。キューの停止・ジョブのキャンセル操作はフロントからGoのメソッドを呼ぶ。

### 6.3 並列実行戦略

RTX 5090の3基NVENCエンジンを活用するため、2つのレイヤで並列化を制御する。

**レイヤ1: プロセス並列（アプリレベル）** — 同時に起動するNVEncCプロセスの数。アプリ設定の「同時実行数」で制御する。Go側の `queue/manager.go` でセマフォ（バッファ付きチャネル）を使ったワーカープールを実装し、指定数だけ並列にプロセスを起動する。デフォルト値は1。UIではドロップダウンで1〜4を選択肢とし、直接入力で最大8まで設定可能。

**レイヤ2: ジョブ内並列（NVEncC内部）** — `--split-enc` や `--parallel` によるNVEncC内部の並列化。プロファイルで制御する。

2つのレイヤの組み合わせに関する設計方針は以下の通り。

- デフォルト設定は「同時実行数=1 + split-enc auto」。これが最も安全で、多くのケースで十分高速
- 短い動画が大量にある場合は「同時実行数=2〜3 + split-enc off」のほうがスループットが高い
- 過剰な並列の組み合わせ（例: 同時実行数=3 + split-enc forced_3）はNVENCセッション枯渇やVRAM不足を引き起こし得る。アプリ側では制限やガードは行わないが、問題発生時の原因特定を容易にするため、各ジョブのログに同時実行状況を記録する

同時実行数の設定はプロファイルではなくアプリ設定に含める。これはハードウェア構成に依存するパラメータであり、エンコード品質設定とは性格が異なるため。

**並列実行時の出力パス競合防止**: 出力パスの確定はジョブ開始直前にmutex（`sync.Mutex`）下で行う。auto_rename時の連番付与もこのmutex内で実行することで、複数ワーカーが同時に同名を選択する競合を防止する。

**並列実行時の一時ファイル方式**: エンコードは `{dir}/{name}.{job_id}.tmp.{ext}` の一時ファイルに出力する（最終拡張子を維持する）。エンコード成功後に最終パスにリネームし、ファイル日時を復元する。失敗時は一時ファイルを削除する（keep_failed_temp=true の場合は保持）。これにより、途中生成の不完全なファイルが最終出力先に残ることを防ぐ。

### 6.4 コマンドライン構築

`command_builder.go` がプロファイル構造体からNVEncCのコマンドライン引数列を生成する。構築順序は以下の通り。

1. デコーダ指定: `--avhw` または `--avsw`
2. 入力指定: `-i {input_path}`
3. コーデック: `-c hevc`
4. 第1層GUIオプション: レート制御、プリセット、ビット深度、映像詳細、高速化、音声、HDR、メタデータ等
5. 第2層カスタムオプション: テキスト入力欄の内容をそのまま追加（後方優先で上書き）
6. 出力指定: `-o {output_path}`

日本語パス・空白・特殊文字を含むWindowsファイルパスに対応する。`os/exec` はWindowsの `CreateProcess` を内部的に使用し、引数のクォートを自動処理するため、Go側でのエスケープ処理は不要。コマンドプレビューは参考表示としてベストエフォートでクォートする。

### 6.5 NVEncC進捗パース

NVEncCはstderrに進捗を `\r` で上書きしながら出力する。Go側で `\r` / `\n` をデリミタとするカスタムスキャナーで行単位に読み取り、正規表現で進捗情報を抽出する。

**開発初期段階で実施すべき事項**: NVEncC64.exeの実際の出力を、以下の各パターンでファイルに記録し、パーサーの仕様とテストデータを確定する。

- 通常エンコード（H.264 / HEVC / AV1 各コーデック）
- `--split-enc` 使用時
- `--parallel` 使用時
- プロセス並列（複数NVEncCプロセス同時実行）時の各プロセスの出力
- エラー発生時（入力ファイル不正、GPU非対応、コーデック非対応オプション等）
- 入力ファイルの長さが不明な場合

パースが失敗した場合（NVEncCの出力形式が変わった場合等）は進捗を「不明」として扱い、エンコード自体は続行する。ログウィンドウには常にパース前の生の出力を表示する。

進捗イベントの発火は500ms間隔にスロットリングし、フロントエンドへの過剰な通知を防ぐ。複数プロセス並列実行時は、各ジョブのイベントにジョブIDを付与して区別する。

各ジョブについて、ハング検出用に以下の2つのタイムスタンプを管理する。

- `lastLineAt`: stderrから何らかの行を受信した最終時刻
- `lastProgressAt`: 進捗パースに成功し進捗値が更新された最終時刻

タイムアウト判定ロジックとの関係は F-08 に記載。

### 6.6 プロセス管理

Goの `os/exec` でNVEncCを起動する。

**プロセスツリー管理**: NVEncCプロセスの起動時にWindows Job Object を作成・割り当てる。

- `CreateJobObject` でジョブオブジェクトを作成
- `SetInformationJobObject` で `JOB_OBJECT_LIMIT_KILL_ON_JOB_CLOSE` フラグを設定する。これにより、アプリがクラッシュした場合にもジョブオブジェクトのハンドルが閉じられ、子プロセスが自動終了する
- `AssignProcessToJobObject` でNVEncCプロセスを割り当て
- キャンセル時は `TerminateJobObject` でプロセスツリーごと終了
- Job Objectの作成・割り当てに失敗した場合（既に別のJob Objectに属している等）は `taskkill /F /T /PID` にフォールバックする
- Job Objectの使用可否は `job.json` に記録する

**ハング検出**: F-08に記載の2段階タイムアウトで判定する。

**デコーダフォールバック**: `--avhw` で失敗した場合（終了コード非0）に `--avsw` に切り替えて1回だけ自動再試行する。アプリ設定でON/OFF可能、デフォルトOFF。再試行時はログに「avhw失敗、avswで再試行」を記録する。

### 6.7 外部ツール検出

**NVEncC64.exe**: 公式名は `NVEncC64.exe` とする。以下の順序・候補で検出する。

1. アプリ設定で指定された絶対パス（設定済みの場合）
2. アプリexeと同一フォルダ内を検索。候補ファイル名（優先順）:
   - `NVEncC64.exe`（公式名、優先）
   - `NVEncC.exe`（互換候補）
3. PATH環境変数から上記の候補名で検索

検出後、起動時のヘッダ行出力からバージョンを取得する。8.x未満の場合は警告を表示する。

**ffmpeg.exe / ffprobe.exe**: 同様の順序で検出するが、見つからなくてもエラーとはしない。検出結果はアプリ設定画面に表示する。

### 6.8 プロファイルのデータ構造

```
Profile {
    id:          string (UUID)
    version:     int    (マイグレーション用)
    name:        string
    is_preset:   bool   (同梱プリセットかどうか)

    // 映像基本
    codec:       "h264" | "hevc" | "av1"
    rate_control: "qvbr" | "cqp" | "cbr" | "vbr"
    rate_value:  float
    preset:      "P1" ... "P7"
    output_depth: 8 | 10
    multipass:   "none" | "quarter" | "full"
    output_res:  string  (空文字 = 変更なし)

    // 映像詳細
    bframes:     int | null  (null = NVEncCデフォルトに委ねる)
    ref:         int | null
    lookahead:   int | null
    gop_len:     int | null
    aq:          bool
    aq_temporal: bool

    // 高速化（ジョブ内並列）
    split_enc:   "off" | "auto" | "auto_forced" | "forced_2" | "forced_3" | "forced_4"
    parallel:    "off" | "auto" | 2 | 3
    decoder:     "avhw" | "avsw"
    device:      "auto" | int

    // 音声
    audio_mode:  "copy" | "aac" | "opus"
    audio_bitrate: int  (kbps)

    // HDR・色空間
    colormatrix: "auto" | "bt709" | "bt2020nc" | ...
    transfer:    "auto" | "bt709" | "smpte2084" | "arib-std-b67" | ...
    colorprim:   "auto" | "bt709" | "bt2020" | ...
    colorrange:  "auto" | "limited" | "full"
    max_cll:     string  ("" | "copy" | 手動値)
    master_display: string
    dhdr10_info: "off" | "copy"
    dolby_vision_rpu: "off" | "copy"

    // メタデータ
    metadata_copy:       bool
    video_metadata_copy: bool
    audio_metadata_copy: bool
    chapter_copy:        bool
    sub_copy:            bool
    data_copy:           bool
    attachment_copy:     bool
    restore_file_time:   bool

    // カスタムオプション（第2層）
    custom_options: string

    // 将来の拡張用（初期実装では未使用）
    // profile_override_id: string | null
}
```

### 6.9 アプリ設定のデータ構造

プロファイルとは別に、ハードウェア構成やアプリ動作に関する設定を管理する。

```
AppConfig {
    version:                 int
    nvencc_path:             string  (空文字 = 自動検出)
    ffmpeg_path:             string  (空文字 = 自動検出、任意)
    ffprobe_path:            string  (空文字 = 自動検出、任意)
    max_concurrent_jobs:     int     (デフォルト: 1、UI選択肢: 1〜4、直接入力上限: 8)
    on_error:                "skip" | "stop"  (デフォルト: "skip")
    decoder_fallback:        bool    (--avhw失敗時に--avsw再試行、デフォルト: false)
    keep_failed_temp:        bool    (失敗時の一時ファイル保持、デフォルト: false)
    no_output_timeout_sec:   int     (デフォルト: 600)
    no_progress_timeout_sec: int     (デフォルト: 300)
    post_complete_action:    "none" | "shutdown" | "sleep" | "custom"
    post_complete_command:   string  (custom時のコマンド)
    output_folder_mode:      "same_as_input" | "specified"
    output_folder_path:      string
    output_name_template:    string  (デフォルト: "{name}_encoded")
    output_container:        string  (デフォルト: "mkv")
    overwrite_mode:          "ask" | "auto_rename"
    language:                "ja" | "en"
    default_profile_id:      string
}
```

### 6.10 テスト戦略

**ユニットテスト（最優先）**: `command_builder.go`。プロファイルの各組み合わせに対して、期待されるコマンドライン引数列を検証する。カスタムオプションの追加、nullフィールドの省略、コーデック固有オプションの出し分け等を網羅する。

**ユニットテスト**: `progress_parser.go`。開発初期段階で収集した実出力サンプルをテストデータとし、パーサーが正しく進捗値を抽出することを検証する。パース失敗時のフォールバック動作（「不明」として扱い続行する）も検証する。

**ユニットテスト**: `profile/manager.go` のマイグレーション。旧バージョンのプロファイルJSONを読み込み、現行構造に変換できることを検証する。

**ユニットテスト**: 出力パス確定ロジック。auto_rename時の連番付与、並列呼び出し時の排他制御（goroutineで同時に呼び出して衝突しないことを確認）を検証する。

**手動テスト**: 各コーデック（H.264 / HEVC / AV1）× 各レート制御 × split-enc / parallel × 同時実行数の主要組み合わせマトリクスで実際のエンコードを実行し、動作確認する。

## 6.11 ジョブ実行記録（job.json）スキーマ

ジョブごとに保存する実行記録のスキーマ。ログディレクトリ（`%APPDATA%/Enque/logs/`）に `{job_id}.json` として保存する。

```
JobRecord {
    schema_version:       int     (初期値: 1)
    app_version:          string  (Enqueのバージョン)
    job_id:               string  (UUID)

    // プロファイル情報
    profile_id:           string
    profile_name:         string
    profile_version:      int

    // 入出力
    input_path:           string
    temp_output_path:     string  (一時ファイルパス)
    final_output_path:    string  (最終出力パス)

    // NVEncC実行情報
    nvencc_path:          string  (使用したNVEncC64.exeの絶対パス)
    argv:                 []string (確定コマンドライン引数配列)
    device:               "auto" | int  (使用GPUデバイスID or "auto")

    // 並列実行コンテキスト
    max_concurrent_jobs:  int     (アプリ設定値)
    worker_id:            int     (このジョブを実行したワーカーID、0 から max_concurrent_jobs-1)

    // プロセス管理
    used_job_object:      bool    (Job Object使用の成否)

    // 実行結果
    started_at:           string  (ISO 8601)
    finished_at:          string  (ISO 8601)
    exit_code:            int
    status:               "completed" | "failed" | "cancelled" | "timeout"
    error_message:        string  (エラー時のメッセージ、なければ空)
    retried_with_avsw:    bool    (avhw→avswフォールバック再試行が発生したか)
}
```
