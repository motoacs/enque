# Enque

[rigaya氏のNVEncC](https://github.com/rigaya/NVEnc)をバックエンドに使用する、プロフェッショナル向けバッチ動画エンコーダフロントエンド。NVIDIA GPUユーザーのための、並列ジョブ実行・高度なプロファイル管理・メタデータ保持に対応したデスクトップアプリケーションです。

**[English version is here](README.md)**

## 概要

Enqueは、エンコーダCLIのオプションを理解している上級ユーザーが、日常のバッチエンコード作業を効率化するために設計されたWindows向けデスクトップアプリケーションです。主要なNVEncCオプションをGUIウィジェットで提供しつつ、テキスト入力で任意のCLIオプションを自由に追加できる柔軟性を持ちます。

### 主な機能

- **バッチエンコード** -- ドラッグ＆ドロップで複数ファイル・フォルダをジョブキューに追加し、一括エンコード
- **並列実行** -- 最大8つのNVEncCプロセスを同時実行し、GPU使用率を最大化（例: RTX 5090の3基NVENCエンジン活用）
- **プロファイル管理** -- エンコード設定の保存・複製・切り替え。4つのビルトインプリセットを同梱
- **NVEncCオプションの網羅** -- 主要設定のGUIウィジェット ＋ 任意のNVEncCオプションを自由入力
- **リアルタイム進捗** -- ジョブごとの進捗バー（fps、ビットレート、残り時間）。stderrログのリアルタイム表示
- **コマンドプレビュー** -- 実行されるNVEncCコマンドラインを常時表示、クリップボードへコピー可能
- **ファイル日時復元** -- エンコード後に元ファイルの作成日時・更新日時を出力ファイルに復元（Win32 API使用）
- **メタデータパススルー** -- コンテナメタデータ、チャプター、字幕、データトラック、添付ファイルのコピー
- **ジョブ制御** -- 個別スキップ、停止（現在のジョブ完了後に停止）、全体の強制終了
- **完了後アクション** -- 全ジョブ完了後にシャットダウン・スリープ・カスタムコマンドを自動実行
- **日本語・英語対応** -- UIの完全二言語対応

## 動作要件

- **OS**: Windows 11 (x64)
- **GPU**: NVENC対応のNVIDIA GPU
- **NVEncC**: [NVEncC64.exe](https://github.com/rigaya/NVEnc) 8.x以降（必須）

### オプション

- QSVEncC64.exe -- 検出・保存のみ（将来のサポートに向けた準備）
- ffmpeg.exe / ffprobe.exe -- 検出・保存のみ（将来のサポートに向けた準備）

## インストール

1. 最新リリースのZIPファイルをダウンロード
2. 任意のフォルダに展開
3. `NVEncC64.exe` を `Enque.exe` と同じフォルダに配置するか、システムPATHに設定
4. `Enque.exe` を実行

初回起動時に、アプリケーションフォルダおよびPATHからNVEncCを自動検出します。見つからない場合は、設定画面でパスを手動指定できます。

インストーラーは不要です。設定ファイルは `%APPDATA%\Enque\` に保存されます。

## クイックスタート

1. **ファイルを追加** -- 動画ファイルをウィンドウにドラッグ＆ドロップ、またはファイル/フォルダダイアログから選択
2. **プロファイルを選択** -- ビルトインプリセットから選ぶか、独自のプロファイルを作成
3. **出力設定** -- 出力先フォルダ、ファイル名テンプレート、コンテナ形式を設定
4. **コマンドを確認** -- プロファイルエディタ下部のコマンドプレビューで最終コマンドを確認
5. **エンコード開始** -- 開始ボタンを押して、リアルタイムで進捗を監視

## 同梱プリセット

| プリセット | コーデック | 品質 | プリセット | 特徴 |
|-----------|----------|------|-----------|------|
| **HEVC Quality** | HEVC | QVBR 28 | P4 | 10-bit、速度と品質のバランス、split-enc auto |
| **AV1 Fast** | AV1 | QVBR 32 | P1 | 10-bit、最速スループット、split-enc auto |
| **Camera Archive** | HEVC | QVBR 24 | P7 | 10-bit、最高品質、音声コピー、全メタデータ＋ファイル日時保持 |
| **H.264 Compatible** | H.264 | QVBR 26 | P4 | 8-bit、AAC 256kbps、最大限の互換性 |

プリセットは直接編集できません。複製してカスタマイズしてください。

## プロファイル設定

### GUIオプション（第1層）

以下のNVEncCオプションをGUIウィジェットで提供します:

- **映像基本**: コーデック（H.264/HEVC/AV1）、レート制御（QVBR/CQP/CBR/VBR）、品質値/ビットレート、プリセット（P1-P7）、出力ビット深度（8/10-bit）、マルチパス、出力解像度
- **映像詳細**: Bフレーム数、参照フレーム数、ルックアヘッド、GOP長、空間/時間AQ
- **高速化**: Split Encoding、Parallel Encoding、デコーダ（avhw/avsw）、デバイス指定
- **音声**: コピー / AAC / Opus（ビットレート指定）
- **色空間・HDR**: Color Matrix、Transfer、Primaries、Range、HDR10+パススルー
- **メタデータ**: コンテナ/映像/音声メタデータコピー、チャプター、字幕、データトラック、添付ファイル、ファイル日時復元
- **上級オプション**: インターレース、入出力CSP、Tune、最大ビットレート、VBR Quality、Weighted P Frame、MV Precision、Level/Profile/Tier、SSIM/PSNR計測、Trim/Seek 等

### カスタムオプション（第2層）

GUIに用意されていないNVEncCオプションは、テキスト入力欄にコマンドラインオプションとして自由に記述できます。GUI設定の末尾に追加され、「後方優先」で適用されます。

### 優先順位

```
GUI標準オプション -> GUI上級オプション -> カスタムオプション（最優先）
```

## 並列エンコード

Enqueは2つのレイヤで並列化を制御します:

- **プロセス並列**（アプリ設定）: NVEncCプロセスの同時実行数（1〜8）
- **ジョブ内並列**（プロファイル設定）: NVEncCの `--split-enc` / `--parallel` オプション

デフォルト: 同時実行数1 ＋ split-enc auto。短い動画が大量にある場合は、同時実行数2〜3 ＋ split-enc offが効果的です。

## 出力設定

- **出力先フォルダ**: 入力ファイルと同じフォルダ、または指定フォルダ
- **ファイル名テンプレート**: `{name}`（拡張子なし元ファイル名）、`{ext}`（出力コンテナ拡張子）を使用可能。デフォルト: `{name}_encoded.{ext}`
- **出力コンテナ**: mp4, mkv, mov, webm 等
- **既存ファイルとの衝突**: 上書き確認、または自動リネーム（連番付与）

エンコードは一時ファイル（`{name}.{id}.tmp.{ext}`）に出力し、成功後に最終ファイル名にリネームします。不完全なファイルが最終出力先に残ることを防ぎます。

## エンコード中のジョブ制御

- **スキップ**: 待機中の個別ジョブをスキップ指定
- **キャンセル**: 実行中の特定ジョブを強制終了
- **残りをスキップ**: 実行中のジョブは完了まで走り、次のジョブを開始しない
- **すべて強制終了**: 実行中のジョブを含め即座に強制終了

## 設定ファイル

設定は `%APPDATA%\Enque\` に保存されます:

```
%APPDATA%\Enque\
  config.json            # アプリ設定
  profiles.json          # エンコードプロファイル
  logs/
    {job_id}.json        # ジョブ実行記録（コマンドライン、終了コード、実行時間）
    {job_id}.stderr.log  # エンコーダstderr出力全文
```

### アプリ設定

| 設定項目 | デフォルト | 説明 |
|---------|----------|------|
| 同時実行数 | 1 | 同時に起動するエンコーダプロセス数（1〜8） |
| エラー時動作 | スキップ | 失敗したジョブをスキップして続行、またはキューを停止 |
| デコーダフォールバック | OFF | --avhw失敗時に--avswで自動再試行 |
| 出力タイムアウト | 600秒 | stderr出力が途絶えた場合にプロセスを強制終了 |
| 進捗タイムアウト | 300秒 | 進捗が停滞した場合にプロセスを強制終了 |
| 完了後アクション | なし | 全ジョブ完了後にシャットダウン・スリープ・カスタムコマンド |

## 技術スタック

| 領域 | 技術 |
|-----|------|
| バックエンド | Go 1.23 |
| デスクトップフレームワーク | [Wails](https://wails.io/) v2 |
| フロントエンド | React 18 + TypeScript + Vite |
| 状態管理 | Zustand |
| UIコンポーネント | Radix UI + Tailwind CSS |
| データ永続化 | JSONファイル |
| プロセス管理 | Windows Job Objects |

## ソースからビルド

### 前提条件

- Go 1.23以上
- Node.js 18以上
- [Wails CLI](https://wails.io/docs/gettingstarted/installation) v2

### ビルド

```bash
# 依存関係のインストール
cd frontend && npm install && cd ..

# 開発モード（ホットリロード）
wails dev

# プロダクションビルド
wails build
```

ビルドされた実行ファイルは `build/bin/Enque.exe` に出力されます。

### テスト実行

```bash
# バックエンドテスト
go test ./...

# フロントエンド型チェック
cd frontend && npm run build
```

## アーキテクチャ

Enqueは、フロントエンドとバックエンドを明確に分離し、定義されたAPI境界を持つ設計です:

- **エンコード前**: フロントエンド（Zustand store）がキュー・プロファイル編集のSource of Truth
- **エンコード中**: バックエンド（Go）がSource of Truth。進捗はWailsイベントでフロントエンドにプッシュ
- **エンコーダ抽象化**: Registry + Adapterパターン。v1はNVEncCを実装、QSVEncC/ffmpegアダプタはコアロジック変更なしで追加可能

```
React + Zustand (UI & 状態管理)
    |
    +-- Wails Bindings (関数呼び出し)
    +-- Wails Events (Go -> JS, リアルタイム通知)
    |
Go バックエンド
    +-- queue/     セッション管理、ワーカープール
    +-- encoder/   アダプタレジストリ、プロセス実行、タイムアウト監視
    |   +-- nvencc/  コマンドビルダー、進捗パーサー
    +-- profile/   CRUD、マイグレーション、プリセット
    +-- config/    アプリ設定、マイグレーション
    +-- detector/  外部ツール検出、GPU機能情報
    +-- metadata/  Win32ファイル日時復元
    +-- logging/   ジョブ記録、stderr保存
```

## ライセンス

[MIT License](LICENSE) - Copyright (c) 2026 motoacs

## 謝辞

- [rigaya/NVEnc](https://github.com/rigaya/NVEnc) -- Enqueが使用するNVEncCエンコーダ
- [Wails](https://wails.io/) -- Go + Webデスクトップアプリケーションフレームワーク
- [Radix UI](https://www.radix-ui.com/) -- アクセシブルなUIコンポーネントプリミティブ
